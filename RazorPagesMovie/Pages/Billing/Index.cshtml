@page
@model RazorPagesMovie.Pages.Billing.IndexModel
@{
    ViewData["Title"] = "Index";
}
<div class="card mb-2" style="background-color:darkslateblue">
    <div class="card-body d-flex justify-content-center align-items-center mb-2" style="height: 50px ; overflow: hidden;">
        <h2 style="color: white">Billing Information</h2>
    </div>
</div>
<div class="row">
    <div class="col-md-6">
        <table class="table table-bordered invoice-info">
            <thead>
                <tr>
                    <th colspan="2">Invoice Details</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Reservation != null)
                {
                    <input type="hidden" asp-for="Reservation.MasterbillId">
                    <input type="hidden" asp-for="Reservation.Id">
                    <input type="hidden" asp-for="Reservation.CustomerName">
                    <input type="hidden" asp-for="Reservation.SelectedRooms">
                    <input type="hidden" asp-for="Reservation.SelectedRoomsNos">
                    <input type="hidden" asp-for="Reservation.CheckInDate">
                    <input type="hidden" asp-for="Reservation.ExpectedCheckOutDate">
                    <input type="hidden" asp-for="Reservation.Mobile">
                    <input type="hidden" asp-for="Reservation.Address">
                    <input type="hidden" asp-for="Reservation.Country">
                    <input type="hidden" asp-for="Reservation.GuestCount">
                    <input type="hidden" asp-for="Reservation.NIN">


                    <tr>
                        <td >Invoice No:</td>
                        <td>@Model.Reservation.CheckInDate.ToString("yyyyMMdd") - @Model.Reservation.Id</td>
                    </tr>
                    <tr>
                        <td>Customer Name:</td>
                        <td>@Model.Reservation.CustomerName</td>
                    </tr>
                    <tr>
                        <td>Reserved Rooms:</td>
                        <td>@Model.Reservation.SelectedRoomsNos</td>
                    </tr>
                    <tr>
                        <td>Check-In Date:</td>
                        <td>@Model.Reservation.CheckInDate.ToShortDateString()</td>
                    </tr>
                    <tr>
                        <td>Check-Out Date:</td>
                

                        <td>

                            @await Html.PartialAsync("_partialEditCheckoutDate", @Model.Reservation)

                   
                              
                            
                        </td>
                    </tr>

                  

                 

                    <tr>
           

                        <td>Initialize Check-Out</td>
                        <td>
                          

                            <form method="post" asp-page-handler="CheckOut" onsubmit="return confirmCheckOut();">
                                <input type="hidden" name="sid" value="@Model.Reservation.Id" />
                                <button type="submit" class="btn btn-danger btn-sm">
                                   Check Out
                                </button>
                            </form>
                        </td>
                    </tr>


                   

                }
                else
                {

                    <tr>
                        <td colspan="2">Reservation not found.</td>
                    </tr>
                }
            </tbody>
        </table>


    </div>


    
    <div class="col-md-6">
        <table class="table-borderless" style="min-width:100%">

           @*  <table class="table"> *@
                <thead>
                    <tr>
                        <th colspan="2" class="text-center">Add Billing Transactions</th>
                    </tr>
                </thead>
                <tbody>
                    <form method="post" id="billingForm">
                    <tr>
                        <td class="fw-bold">Billing Category</td>
                        <td>
                            <select asp-for="NewTransaction.Category" class="form-control">
                                <option value="1">Food</option>
                                <option value="2">VAS</option>
                                <option value="3">ETC</option>
                            </select>
                            <span asp-validation-for="NewTransaction.Category" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Bill Item</td>
                        <td>
                            <input asp-for="NewTransaction.BillingItem" class="form-control" required />
                            <span asp-validation-for="NewTransaction.BillingItem" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Item Amount</td>
                        <td>
                            <input asp-for="NewTransaction.ItemPrice" class="form-control" type="number" step="0.01" required />
                            <span asp-validation-for="NewTransaction.ItemPrice" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Item Quantity</td>
                        <td>
                            <input asp-for="NewTransaction.ItemQty" class="form-control" type="number" step="0.01" required />
                            <span asp-validation-for="NewTransaction.ItemQty" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Description</td>
                        <td>
                            <textarea asp-for="NewTransaction.Description" class="form-control"></textarea>
                            <span asp-validation-for="NewTransaction.Description" class="text-danger"></span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2" class="text-end">
                            <input type="hidden" asp-for="Reservation.MasterbillId" />
                            <input type="hidden" asp-for="Reservation.Id" />
                            <input type="hidden" asp-for="Reservation.CustomerName" />
                            <input type="hidden" asp-for="Reservation.SelectedRooms" />
                            <input type="hidden" asp-for="Reservation.CheckInDate" />
                            <input type="hidden" asp-for="Reservation.ExpectedCheckOutDate" />
                            <input type="hidden" asp-for="Reservation.Mobile" />
                            <input type="hidden" asp-for="Reservation.Address" />
                            <input type="hidden" asp-for="Reservation.Country" />
                            <input type="hidden" asp-for="Reservation.GuestCount" />
                            <input type="hidden" asp-for="Reservation.NIN" />

                            <button type="submit" id="submitBtn" class="btn btn-success rounded-pill mt-2 mb-4" disabled>Add Transaction</button>

                        </td>
                    </tr>
                   
                    </form>
                </tbody>
       </table>

    </div>

</div>
<!-- Display Billing Transactions -->
<h4 class="border border-2 border" style="background-color: #8294C4; color:azure;">Billing Transactions</h4>
@if (Model.BillingTransactions != null && Model.BillingTransactions.Any())
{
    <table class="table table-bordered" id="invoiceTable">
        <thead>
            <tr>
                <th class="center-text">#</th>
@*                 <th class="center-text">Date</th>
 *@                <th class="center-text" style="  min-width: 120px;">Date</th>
                <th class="center-text">Category</th>
                <th class="center-text">Item</th>
                <th class="center-text">Description</th>
                <th class="center-text">Amount</th>
                <th class="center-text">Quantity</th>
                <th class="center-text">Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody>

            @{
                int rowNumber = 1;
            }

            @foreach (var transaction in Model.BillingTransactions)
            {
                decimal? itemTotal = @transaction.ItemPrice * @transaction.ItemQty;
                <tr>
                    <td class="center-text fw-bold small">@rowNumber</td>
                    <td class="center-text">@transaction.createdDate?.ToString("yyyy-MM-dd")</td>
                    <td class="center-text">
                        @if (@transaction.Category == "1")
                        {
                            <div>Food</div>
                        }
                        else if (@transaction.Category == "2")
                        {
                            <div>VAS</div>
                        }
                        else if (@transaction.Category == "3")
                        {
                            <div>ETC</div>
                        }
                    </td>
                    <td>@transaction.BillingItem</td>
                    <td>@transaction.Description</td>
                    <td class="right-text">@transaction.ItemPrice</td>
                    <td class="right-text">@transaction.ItemQty</td>
                    <td class="right-text">@itemTotal</td>


                  
                    <td class="center-text">
                        <form method="post" asp-page-handler="Deleteddd" onsubmit="return confirmDelete();">
                            <input type="hidden" name="id" value="@transaction.Id" />
                            <button type="submit" class="delete-button">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>

                    
                </tr>
                rowNumber++;
                @if (Model.TotalAmount == 0) // Avoid redundant calculations
                {
                    Model.TotalAmount = Model.BillingTransactions.Sum(t => t.ItemPrice * t.ItemQty);
                }
            }
            <tr>
                <th colspan="7" style="text-align: right;">Grand Total</th>
                <td class="right-text">@Model.BillingTransactions.Sum(t => t.ItemPrice * t.ItemQty)</td>
                <td></td>
            </tr>
        </tbody>
    </table>

    <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="checkoutModalLabel">Modify Check-Out Date</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="checkoutForm" asp-page-handler="UpdateCheckout">
                        <div class="mb-3">
                            <label for="checkoutDate" class="form-label">New Check-Out Date</label>
                            <input type="hidden" id="resId" name="reservationId" value="@Model.Reservation.Id" />
                            <input type="date" class="form-control" id="checkoutDate" name="newCheckoutDate" required>
                        </div>
                        <div class="modal-footer">
                           

                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" id="saveCheckoutDateBtn" class="btn btn-primary">Save Changes</button>
                         </div>
                    </form>
                </div>
            </div>
        </div>
    </div> 


    


}
else
{
    <div class="alert alert-warning">No billing transactions found..</div>
}
@section Scripts {
    <script>
        $(document).ready(function () {
           
            $("#btnSaveNewCheckout").click(function () {
                
                console.log("----------------ksg")
                    $.ajax({
                    type: "POST",
                    url: "/Billing/Index/UpdateCheckoutDate",                  
                    headers: {
                        "RequestVerificationToken": $("input:hidden[name='__RequestVerificationToken']").val() 
                        },
                    data: $("#NewCheckOutDt").serialize(),
                    success: function (response) {
                            if (response.success) {
                               console.log("It works!")
                                alert("Checkout date added successfully!");
                            } else {
                                alert("Error adding checkout date: " + response.errorMessage);
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.error("AJAX Error:", textStatus, errorThrown);
                            // Handle errors appropriately (e.g., display error message to user)
                        }
                    });
                
            });
        });

        

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('billingForm');
            const submitBtn = document.getElementById('submitBtn');
            const requiredFields = form.querySelectorAll('input[required], select[required], textarea[required]');

            function checkFields() {
                let allFilled = true;
                requiredFields.forEach(function (field) {
                    console.log(field.name, field.value); // Debugging: Log field name and value
                    if (!field.value.trim()) {
                        allFilled = false;
                    }
                });
                console.log('All fields filled:', allFilled); // Debugging: Log allFilled status
                submitBtn.disabled = !allFilled;
                console.log('Submit button status:', submitBtn.disabled); // Debugging: Log button status
            }

            requiredFields.forEach(function (field) {
                field.addEventListener('input', checkFields);
            });
            checkFields(); // Initial check


        });

        function confirmDelete() {
            return confirm("Are you sure you want to delete this transaction?");
        }

        function confirmCheckOut() {
            return confirm("Are you sure you want to process Check-Out?");
        }

        function confirmUpdateCheckOut() {
            
            return confirm("Are you sure you want to update the check-out date?");
        }

    </script>
}


